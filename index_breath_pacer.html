<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal</title>
<meta name="theme-color" content="#080604">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;1,400;1,500&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0a0908;
  --cream: #ede0ce;
  --cream-dim: rgba(237,224,206,0.55);
  --cream-ghost: rgba(237,224,206,0.22);
  --warm: #c9a97a;
  --warm-bright: #d6b98c;
  --door: rgba(201,169,122,0.7);
  --door-dim: rgba(201,169,122,0.35);
}

html, body {
  height: 100%; overflow: hidden;
  background: var(--bg);
  cursor: default; user-select: none;
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}

/* ── GRAIN ── */
.grain {
  position: fixed; inset: -50%; width: 200%; height: 200%;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 1;
  animation: grainshift 8s steps(2) infinite;
}
@keyframes grainshift {
  0%{transform:translate(0,0)} 25%{transform:translate(-2%,-1%)}
  50%{transform:translate(1%,2%)} 75%{transform:translate(-1%,1%)}
}

/* ══════════════════════════════════════
   WELCOME - MIRROR PORTAL
══════════════════════════════════════ */
#screen-welcome {
  position: fixed; inset: 0; z-index: 20;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: radial-gradient(ellipse 70% 70% at 50% 50%, #0f0d0b 0%, #060504 100%);
  transition: opacity 1.2s ease;
}
#screen-welcome.exiting { opacity: 0; pointer-events: none; }

/* Ambient stars */
.stars {
  position: absolute; inset: 0; overflow: hidden; pointer-events: none;
}
.star {
  position: absolute; width: 1px; height: 1px;
  background: rgba(237,224,206,0.6); border-radius: 50%;
  animation: twinkle var(--d) ease-in-out infinite var(--delay);
}
@keyframes twinkle {
  0%,100%{opacity:0.1} 50%{opacity:0.8}
}

/* Portal mirror container */
.mirror-wrap {
  position: relative;
  width: min(72vw, 320px);
  height: min(72vw, 320px);
  margin-bottom: 44px;
  cursor: pointer;
}

/* Outer glow rings */
.mirror-ring {
  position: absolute;
  border-radius: 50%;
  border: 1px solid rgba(201,169,122,0.2);
  animation: ring-pulse 4s ease-in-out infinite;
}
.mirror-ring.r1 { inset: -16px; animation-delay: 0s; }
.mirror-ring.r2 { inset: -28px; animation-delay: 0.5s; opacity: 0.5; }
.mirror-ring.r3 { inset: -44px; animation-delay: 1s; opacity: 0.25; }
@keyframes ring-pulse {
  0%,100%{opacity:0.2; transform:scale(0.98)}
  50%{opacity:0.6; transform:scale(1.01)}
}

/* The canvas mirror */
#mirror-canvas {
  width: 100%; height: 100%;
  border-radius: 50%;
  display: block;
  position: relative; z-index: 2;
  box-shadow:
    0 0 60px rgba(201,169,122,0.15),
    0 0 120px rgba(201,169,122,0.08),
    inset 0 0 40px rgba(0,0,0,0.4);
}

/* Portal text on mirror */
.mirror-label {
  position: absolute; inset: 0; z-index: 3;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  pointer-events: none;
  border-radius: 50%;
  overflow: hidden;
}
.mirror-portal-text {
  font-family: 'Playfair Display', serif;
  font-size: clamp(28px, 8vw, 42px);
  font-weight: 400; font-style: italic;
  color: rgba(237,224,206,0.85);
  letter-spacing: 0.08em;
  text-shadow:
    0 0 30px rgba(201,169,122,0.8),
    0 0 60px rgba(201,169,122,0.4),
    0 2px 4px rgba(0,0,0,0.5);
  animation: portal-glow 4s ease-in-out infinite;
}
@keyframes portal-glow {
  0%,100%{ text-shadow: 0 0 20px rgba(201,169,122,0.6), 0 0 50px rgba(201,169,122,0.3); }
  50%{ text-shadow: 0 0 40px rgba(201,169,122,1), 0 0 80px rgba(201,169,122,0.5), 0 0 120px rgba(201,169,122,0.2); }
}
.mirror-touch-hint {
  font-family: 'EB Garamond', serif;
  font-size: 12px; letter-spacing: 0.35em;
  text-transform: uppercase;
  color: rgba(237,224,206,0.35);
  margin-top: 10px;
  animation: hint-pulse 3s ease-in-out infinite 2s;
}
@keyframes hint-pulse {
  0%,100%{opacity:0.35} 50%{opacity:0.7}
}

/* Welcome tagline */
.welcome-tag {
  font-family: 'Playfair Display', serif;
  font-size: clamp(16px, 4vw, 22px);
  font-weight: 400; font-style: italic;
  color: var(--cream-dim);
  text-align: center; letter-spacing: 0.02em;
  line-height: 1.5;
  opacity: 0; animation: fadeup 2s ease forwards 1.2s;
}

/* ══════════════════════════════════════
   INTERIOR - after crossing
══════════════════════════════════════ */
#interior {
  position: fixed; inset: 0; z-index: 10;
  display: none; opacity: 0;
  transition: opacity 1s ease 0.3s;
}
#interior.visible { display: block; opacity: 1; }

/* Two fields */
.world { position: fixed; inset: 0; display: flex; }
.world-l { flex:1; background: #151311; }
.world-r { flex:1; background: #1c1a16; }

/* Ambient */
.ambient {
  position: fixed; inset: 0; pointer-events: none; z-index: 2;
  background:
    radial-gradient(ellipse 50% 80% at 50% 50%, rgba(201,169,122,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 80% 40% at 50% 100%, rgba(201,169,122,0.05) 0%, transparent 60%);
  animation: ambientbreathe 7s ease-in-out infinite;
}
@keyframes ambientbreathe{0%,100%{opacity:.8}50%{opacity:1}}

/* Vignette */
.vignette {
  position: fixed; inset: 0; pointer-events: none; z-index: 3;
  background: radial-gradient(ellipse 88% 88% at 50% 50%, transparent 28%, rgba(5,4,3,0.72) 100%);
}

/* Door */
.door-line {
  position: fixed; left:50%; top:0; bottom:0; width:1px;
  transform: translateX(-50%);
  background: linear-gradient(180deg,
    transparent 0%, rgba(201,169,122,0.35) 5%,
    rgba(201,169,122,0.7) 28%, rgba(201,169,122,0.7) 72%,
    rgba(201,169,122,0.35) 95%, transparent 100%);
  z-index: 5; animation: doorbreathe 5s ease-in-out infinite;
}
.door-glow {
  position: fixed; left:50%; top:0; bottom:0; width:100px;
  transform: translateX(-50%); pointer-events: none; z-index: 4;
  background: radial-gradient(ellipse 100% 100% at 50% 50%, rgba(201,169,122,0.09) 0%, transparent 100%);
  animation: doorbreathe 5s ease-in-out infinite;
}
@keyframes doorbreathe{0%,100%{opacity:.7}50%{opacity:1}}
.door-lintel {
  position: fixed; left:50%; top:7vh; transform:translateX(-50%);
  width:80px; height:1px; z-index:6;
  background: linear-gradient(90deg, transparent, rgba(201,169,122,0.7), transparent);
}
.door-sill {
  position: fixed; left:50%; bottom:7vh; transform:translateX(-50%);
  width:56px; height:1px; z-index:6;
  background: linear-gradient(90deg, transparent, rgba(201,169,122,0.35), transparent);
}
.door-serif { position:fixed; left:50%; width:1px; height:18px; background:rgba(201,169,122,0.35); z-index:6; }
.ds-tl{top:calc(7vh - 18px);transform:translateX(-40px)}
.ds-tr{top:calc(7vh - 18px);transform:translateX(39px)}
.ds-bl{bottom:calc(7vh - 18px);transform:translateX(-40px)}
.ds-br{bottom:calc(7vh - 18px);transform:translateX(39px)}

/* Wordmark */
.wordmark {
  position: fixed; top:0; left:0; right:0; z-index:30;
  display: flex; flex-direction: column; align-items: center;
  padding-top: 34px; cursor: pointer;
  opacity: 0; transition: opacity 1s ease;
}
.wordmark.visible { opacity: 1; }
.wordmark-text {
  font-family: 'Playfair Display', serif;
  font-size: clamp(28px,7vw,40px);
  font-weight:400; font-style:italic;
  letter-spacing:0.1em; color:var(--warm-bright);
  line-height:1; margin-bottom:9px; transition:color 0.5s;
}
.wordmark:hover .wordmark-text{color:var(--cream)}
.wordmark-rule {
  width:52px; height:1px;
  background:linear-gradient(90deg,transparent,var(--warm),transparent);
  opacity:0.55;
}

/* Teacher badge */
.teacher-badge {
  position:fixed; top:100px; left:50%; transform:translateX(-50%);
  font-family:'EB Garamond',serif; font-size:11px;
  letter-spacing:0.35em; text-transform:uppercase;
  color:rgba(201,169,122,0.4); z-index:30;
  opacity:0; transition:opacity 1s ease;
}
.teacher-badge.visible{opacity:1}

/* Visit counter */
.visit-count {
  position:fixed; bottom:28px; left:28px; z-index:30;
  font-family:'EB Garamond',serif; font-size:11px;
  letter-spacing:0.2em; color:rgba(237,224,206,0.22);
  opacity:0; transition:opacity 2s ease;
}
.visit-count.visible{opacity:1}

/* Stage */
.stage {
  position:fixed; inset:0; z-index:10;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:130px 32px 110px;
}

/* Screens */
.iscreen {
  display:none; flex-direction:column;
  align-items:center; width:100%; max-width:600px;
}

/* Breath */
.breath-ring {
  position:relative; width:160px; height:160px; margin-bottom:44px;
}
.breath-ring-outer {
  position:absolute; inset:0; border-radius:50%;
  border:1px solid rgba(201,169,122,0.15);
  animation:ring-expand var(--breathDur,10.91s) ease-in-out infinite;
}
.breath-ring-mid {
  position:absolute; inset:16px; border-radius:50%;
  border:1px solid rgba(201,169,122,0.25);
  animation:ring-expand var(--breathDur,10.91s) ease-in-out infinite 0.2s;
}
.breath-core {
  position:absolute; inset:36px; border-radius:50%;
  background:radial-gradient(circle at 38% 38%,rgba(201,169,122,0.55) 0%,rgba(201,169,122,0.1) 60%,transparent 100%);
  border:1px solid rgba(201,169,122,0.3);
  animation:core-breathe var(--breathDur,10.91s) ease-in-out infinite;
}
@keyframes ring-expand{0%,100%{transform:scale(.88);opacity:.3}45%,55%{transform:scale(1.08);opacity:.7}}
@keyframes core-breathe{0%,100%{transform:scale(.82);opacity:.4}45%,55%{transform:scale(1.15);opacity:1}}
.breath-label {
  font-family:'Playfair Display',serif;
  font-size:clamp(22px,5.5vw,30px);
  font-weight:400; font-style:italic; color:var(--cream);
  text-align:center; letter-spacing:0.04em; line-height:1;
  opacity:0; transition:opacity 1.5s ease; margin-bottom:12px;
}
.breath-label.visible{opacity:1}
.breath-sub {
  font-family:'EB Garamond',serif;
  font-size:clamp(13px,3vw,16px);
  font-style:italic; color:var(--cream-dim);
  text-align:center; letter-spacing:0.12em;
  opacity:0; transition:opacity 1.5s ease;
}
.breath-controls{
  display:flex; gap:10px; align-items:center; justify-content:center;
  margin-top:18px; flex-wrap:wrap;
}
.chip{
  appearance:none; -webkit-appearance:none;
  border:1px solid rgba(201,169,122,0.22);
  background:rgba(8,6,4,0.35);
  color:rgba(238,226,207,0.9);
  padding:8px 12px;
  border-radius:999px;
  font-family:inherit;
  font-size:13px;
  letter-spacing:.02em;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.chip:active{ transform: translateY(1px); }
.chip:focus-visible{ outline:2px solid rgba(120,240,177,0.6); outline-offset:2px; }

.breath-sub.visible{opacity:0.5}

/* Question */
.question-text {
  font-family:'Playfair Display',serif;
  font-size:clamp(27px,7vw,42px);
  font-weight:400; font-style:italic; color:var(--cream);
  text-align:center; line-height:1.45; letter-spacing:-0.01em;
  margin-bottom:30px; transition:opacity 1.5s ease;
}
.question-text .word {
  display:inline; opacity:0;
  animation:wordland 0.5s ease forwards;
}
.anchor-text {
  font-family:'EB Garamond',serif;
  font-size:clamp(16px,4vw,20px);
  font-style:italic; color:var(--cream-dim);
  text-align:center; line-height:1.65;
  letter-spacing:0.02em; max-width:360px;
  opacity:0; transition:opacity 2s ease;
}
.anchor-text.visible{opacity:0.62}
.deepener-text {
  font-family:'EB Garamond',serif;
  font-size:clamp(14px,3.5vw,17px);
  font-style:italic; color:rgba(201,169,122,0.55);
  text-align:center; line-height:1.6;
  letter-spacing:0.04em; max-width:320px; margin-top:24px;
  opacity:0; transition:opacity 3s ease;
}
.deepener-text.visible{opacity:1}
.locked-notice {
  font-family:'EB Garamond',serif;
  font-size:11px; letter-spacing:0.3em;
  text-transform:uppercase; color:rgba(201,169,122,0.3);
  margin-top:20px; opacity:0; transition:opacity 2s ease 3s;
}
.locked-notice.visible{opacity:1}

/* Statement */
.statement-text {
  font-family:'Playfair Display',serif;
  font-size:clamp(24px,6vw,38px);
  font-weight:400; font-style:italic; color:var(--cream);
  text-align:center; line-height:1.5;
  letter-spacing:-0.01em; max-width:480px;
}
.statement-text .word{display:inline;opacity:0;animation:wordland 0.5s ease forwards}

@keyframes wordland{from{opacity:0}to{opacity:1}}

/* Next button */
.next-btn {
  position:fixed; bottom:0; left:0; right:0; height:92px;
  display:none; flex-direction:column;
  align-items:center; justify-content:center; gap:8px;
  background:linear-gradient(180deg,transparent 0%,rgba(12,10,8,0.88) 100%);
  border:none; cursor:pointer;
  opacity:0; transition:opacity 0.8s ease; z-index:20; padding-bottom:8px;
}
.next-btn.visible{opacity:1}
.next-arrow {
  width:1px; height:26px;
  background:linear-gradient(180deg,transparent,var(--warm));
  position:relative; animation:arrowpulse 2.5s ease-in-out infinite;
}
.next-arrow::after {
  content:''; position:absolute; bottom:-1px; left:50%;
  width:7px; height:7px;
  border-right:1px solid var(--warm); border-bottom:1px solid var(--warm);
  transform:translateX(-50%) rotate(45deg);
}
.next-label {
  font-family:'EB Garamond',serif; font-size:14px;
  letter-spacing:0.32em; text-transform:uppercase;
  color:var(--warm); opacity:0.82; transition:opacity 0.3s;
}
.next-btn:hover .next-label{opacity:1}
@keyframes arrowpulse{0%,100%{opacity:.5;transform:translateY(0)}50%{opacity:1;transform:translateY(4px)}}

/* Closing */
.closing-text {
  font-family:'Playfair Display',serif;
  font-size:clamp(22px,5.5vw,32px);
  font-weight:400; font-style:italic; color:var(--cream);
  text-align:center; line-height:1.65; white-space:pre-line;
  margin-bottom:56px; opacity:0;
}
.return-btn {
  background:none; border:none;
  font-family:'EB Garamond',serif; font-size:14px;
  letter-spacing:0.35em; text-transform:uppercase;
  color:var(--cream-ghost); cursor:pointer; padding:10px 0;
  opacity:0; transition:color 0.5s;
}
.return-btn:hover{color:var(--cream-dim)}

/* Peripheral whispers */
.whisper {
  position:fixed; z-index:4; pointer-events:none;
  font-family:'Playfair Display',serif;
  font-style:italic; font-size:10px;
  color:rgba(237,224,206,0.05);
  line-height:1.7; max-width:80px;
  opacity:0; transition:opacity 3s ease;
}
.whisper.visible{opacity:1}
.w1{left:6px;top:12%;transform:rotate(-2deg);text-align:left}
.w2{right:5px;top:15%;transform:rotate(1.5deg);text-align:right}
.w3{left:6px;bottom:12%;transform:rotate(1deg);text-align:left}
.w4{right:5px;bottom:15%;transform:rotate(-1.5deg);text-align:right}

/* Exit blessing */
.exit-blessing {
  position:fixed; inset:0; z-index:100;
  display:flex; align-items:center; justify-content:center;
  background:var(--bg); opacity:0; pointer-events:none;
  transition:opacity 1s ease;
}
.exit-blessing.visible{opacity:1;pointer-events:all}
.exit-blessing-text {
  font-family:'Playfair Display',serif;
  font-size:clamp(22px,5vw,32px);
  font-style:italic; color:var(--cream-dim);
  text-align:center; line-height:1.6;
  opacity:0; transition:opacity 1.5s ease 0.5s;
}
.exit-blessing.visible .exit-blessing-text{opacity:1}

/* Teacher mode overrides */
.teacher-mode .anchor-text,
.teacher-mode .deepener-text,
.teacher-mode .next-btn{display:none!important}
.teacher-mode .question-text,
.teacher-mode .statement-text{font-size:clamp(32px,8vw,52px)!important}

/* Keyframes */
@keyframes fadeup{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes qup{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes softin{from{opacity:0}to{opacity:1}}

@media(max-width:430px){
  .stage{padding:115px 24px 100px}
  .mirror-wrap{width:min(80vw,280px);height:min(80vw,280px)}
}

/* === Accessibility + Coherence UX (v1.1) === */
:focus { outline: none; }
:focus-visible { outline: 2px solid rgba(201,169,122,0.75); outline-offset: 3px; border-radius: 10px; }
button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
  .grain { display:none !important; }
}
/* Ambient mode: minimal UI for pure regulation */
body.ambient-mode #wordmark,
body.ambient-mode #teacher-badge,
body.ambient-mode #visit-count,
body.ambient-mode #next-btn,
body.ambient-mode .whisper,
body.ambient-mode .door-glow,
body.ambient-mode .door-line,
body.ambient-mode .door-lintel,
body.ambient-mode .door-sill,
body.ambient-mode .door-serif { opacity: 0 !important; pointer-events:none !important; }
body.ambient-mode .vignette { opacity: 0.9 !important; }
body.ambient-mode #iscreen-breath { transform: translateY(-6px) scale(1.02); }
body.ambient-mode .breath-sub::after {
  content: "  (ambient mode)";
  opacity: 0.7;
  font-size: 0.92em;
}

</style>
</head>
<body>

<div class="grain"></div>

<!-- ══ WELCOME SCREEN ══ -->
<div id="screen-welcome">
  <div class="stars" id="stars"></div>

  <div class="mirror-wrap" id="mirror-wrap">
    <!-- Glow rings -->
    <div class="mirror-ring r1"></div>
    <div class="mirror-ring r2"></div>
    <div class="mirror-ring r3"></div>
    <!-- The mirror -->
    <canvas id="mirror-canvas"></canvas>
    <!-- Portal label over mirror -->
    <div class="mirror-label">
      <span class="mirror-portal-text">Portal</span>
      <span class="mirror-touch-hint">touch to enter</span>
    </div>
  </div>

  <p class="welcome-tag">A question is waiting for you</p>
</div>

<!-- ══ INTERIOR ══ -->
<div id="interior">
  <div class="world"><div class="world-l"></div><div class="world-r"></div></div>
  <div class="ambient"></div>
  <div class="vignette"></div>

  <!-- Whispers -->
  <div class="whisper w1" id="w1"></div>
  <div class="whisper w2" id="w2"></div>
  <div class="whisper w3" id="w3"></div>
  <div class="whisper w4" id="w4"></div>

  <!-- Door -->
  <div class="door-glow"></div>
  <div class="door-line"></div>
  <div class="door-lintel"></div>
  <div class="door-sill"></div>
  <div class="door-serif ds-tl"></div>
  <div class="door-serif ds-tr"></div>
  <div class="door-serif ds-bl"></div>
  <div class="door-serif ds-br"></div>

  <!-- Wordmark -->
  <div class="wordmark" id="wordmark">
    <span class="wordmark-text">Portal</span>
    <div class="wordmark-rule"></div>
  </div>
  <div class="teacher-badge" id="teacher-badge">Teacher mode</div>
  <div class="visit-count" id="visit-count"></div>

  <!-- Stage -->
  <div class="stage">

    <div class="iscreen" id="iscreen-breath">
      <div class="breath-ring">
        <div class="breath-ring-outer"></div>
        <div class="breath-ring-mid"></div>
        <div class="breath-core"></div>
      </div>
      <p class="breath-label" id="breath-label">breathe in</p>
      <p class="breath-sub" id="breath-sub">let yourself arrive</p>
      <div class="breath-controls" aria-label="Breathing pace controls">
        <button class="chip" id="pace-btn" type="button" aria-label="Change breathing pace">Pace: 5.5 bpm</button>
        <button class="chip" id="haptic-btn" type="button" aria-label="Toggle haptics">Haptics: off</button>
      </div>
    </div>

    <div class="iscreen" id="iscreen-question">
      <p class="question-text" id="q-text"></p>
      <p class="anchor-text" id="anchor-text"></p>
      <p class="deepener-text" id="deepener-text"></p>
      <p class="locked-notice" id="locked-notice">sit with this one</p>
    </div>

    <div class="iscreen" id="iscreen-statement">
      <p class="statement-text" id="s-text"></p>
    </div>

    <div class="iscreen" id="iscreen-close">
      <p class="closing-text" id="closing-text"></p>
      <button class="return-btn" id="return-btn" onclick="returnToPortal()" aria-label="Return to the portal">Return</button>
    </div>

  </div>

  <button class="next-btn" id="next-btn" onclick="nextQuestion()" aria-label="Get another question">
    <div class="next-arrow"></div>
    <span class="next-label">Another question</span>
  </button>
</div>

<div class="exit-blessing" id="exit-blessing">
  <p class="exit-blessing-text" id="exit-text"></p>
</div>

<div id="error-banner" aria-live="polite" style="position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;display:none;padding:10px 12px;border:1px solid rgba(201,169,122,0.35);border-radius:14px;background:rgba(8,6,5,0.78);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);color:rgba(255,255,255,0.92);font-family: var(--font-sans, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif);font-size:14px;line-height:1.35;"></div>

<script>
// ── Breath entrainment (coherence pacing) ──────────────────────────────────────
const PACE_PRESETS = [4.5, 5.0, 5.5, 6.0]; // breaths per minute
let paceIndex = 2; // default 5.5 bpm (≈ HRV coherence range)
let hapticsOn = false;
let breathPacerTimer = null;
let breathAdvanceTimer = null;

function setPace(bpm){
  const dur = 60 / bpm; // seconds per full cycle
  document.documentElement.style.setProperty('--breathDur', dur.toFixed(2) + 's');
  const paceBtn = document.getElementById('pace-btn');
  if(paceBtn) paceBtn.textContent = `Pace: ${bpm.toFixed(1)} bpm`;
}

function setHaptics(on){
  hapticsOn = !!on;
  const btn = document.getElementById('haptic-btn');
  if(btn) btn.textContent = `Haptics: ${hapticsOn ? 'on' : 'off'}`;
}

function pulse(ms){
  try{
    if(hapticsOn && navigator.vibrate) navigator.vibrate(ms);
  }catch(e){}
}

function stopBreathPacer(){
  if(breathPacerTimer){ clearInterval(breathPacerTimer); breathPacerTimer=null; }
  if(breathAdvanceTimer){ clearTimeout(breathAdvanceTimer); breathAdvanceTimer=null; }
}

function startBreathPacer(cycles=2){
  stopBreathPacer();
  setPace(PACE_PRESETS[paceIndex]);

  const label = document.getElementById('breath-label');
  const sub = document.getElementById('breath-sub');
  if(!label || !sub) return;

  // Calm copy (minimal, non-performative)
  const inhaleText = 'breathe in';
  const exhaleText = 'breathe out';
  const inhaleSub = 'receive the moment';
  const exhaleSub = 'soften and widen';

  const bpm = PACE_PRESETS[paceIndex];
  const dur = 60 / bpm;                 // full cycle seconds
  const half = dur / 2;                 // inhale/exhale
  let phase = 0;                        // 0 = inhale, 1 = exhale

  const applyPhase = () => {
    if(phase === 0){
      label.textContent = inhaleText;
      sub.textContent = inhaleSub;
      pulse(10);
    }else{
      label.textContent = exhaleText;
      sub.textContent = exhaleSub;
      pulse(12);
    }
    label.classList.add('visible'); sub.classList.add('visible');
  };

  applyPhase();
  breathPacerTimer = setInterval(()=>{
    phase = (phase + 1) % 2;
    // tiny fade for gentleness
    label.style.opacity='0'; sub.style.opacity='0';
    setTimeout(()=>{
      label.style.opacity=''; sub.style.opacity='';
      applyPhase();
    }, 220);
  }, Math.round(half * 1000));

  // Auto-advance to first question after a couple of cycles (tap ring to skip)
  breathAdvanceTimer = setTimeout(()=>{
    try{ displayQuestion(); }catch(e){}
  }, Math.round(dur * cycles * 1000 + 300));
}

// Small, user-friendly error banner (helps diagnose deploy issues)
const __err = document.getElementById('error-banner');
window.addEventListener('error',(ev)=>{
  try{
    if(!__err) return;
    __err.style.display='block';
    __err.textContent = 'Something in the page failed to load or run. If this happened after a copy/paste, re-save the file as plain UTF-8 and redeploy.';
    setTimeout(()=>{ __err.style.display='none'; }, 9000);
  }catch(e){}
});

// ═══════════════════════════════════
// MIRROR CANVAS - liquid shimmer
// ═══════════════════════════════════
const canvas = document.getElementById('mirror-canvas');
const ctx = canvas.getContext('2d');
let W, H, cx, cy, radius;
let ripples = [];
let animFrame;
let hue = 200;
let entered = false;

function resizeMirror() {
  const wrap = document.getElementById('mirror-wrap');
  W = wrap.offsetWidth; H = wrap.offsetHeight;
  canvas.width = W; canvas.height = H;
  cx = W/2; cy = H/2; radius = W/2;
}

// Ripple class
class Ripple {
  constructor(x, y, isEntry=false) {
    this.x = x; this.y = y;
    this.r = 0;
    this.maxR = isEntry ? W*1.5 : W*0.8;
    this.speed = isEntry ? 18 : 6;
    this.alpha = isEntry ? 1 : 0.8;
    this.isEntry = isEntry;
    this.done = false;
  }
  update() {
    this.r += this.speed;
    this.alpha -= this.isEntry ? 0.018 : 0.012;
    if (this.r > this.maxR || this.alpha <= 0) this.done = true;
  }
  draw(ctx) {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    ctx.strokeStyle = `rgba(201,169,122,${Math.max(0,this.alpha)})`;
    ctx.lineWidth = this.isEntry ? 3 : 1.5;
    ctx.stroke();
  }
}

// Iridescent noise particles
let particles = [];
function initParticles() {
  particles = [];
  const count = reduceMotion ? 60 : 180;
  for (let i=0; i<count; i++) {
    const angle = Math.random()*Math.PI*2;
    const r = Math.random()*radius*0.92;
    particles.push({
      x: cx + Math.cos(angle)*r,
      y: cy + Math.sin(angle)*r,
      vx: (Math.random()-0.5)*0.4,
      vy: (Math.random()-0.5)*0.4,
      size: Math.random()*2.5+0.5,
      hue: Math.random()*60+30,
      alpha: Math.random()*0.6+0.1,
      phase: Math.random()*Math.PI*2,
      speed: Math.random()*0.015+0.005
    });
  }
}

function drawMirror(ts) {
  ctx.clearRect(0,0,W,H);

  // Clip to circle
  ctx.save();
  ctx.beginPath();
  ctx.arc(cx,cy,radius,0,Math.PI*2);
  ctx.clip();

  // Base - deep dark mirror
  const bg = ctx.createRadialGradient(cx,cy,0,cx,cy,radius);
  bg.addColorStop(0, 'rgba(28,24,18,0.95)');
  bg.addColorStop(0.5,'rgba(18,15,12,0.98)');
  bg.addColorStop(1,'rgba(8,6,5,1)');
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,W,H);

  // Iridescent shimmer layer
  const t = ts*0.001;
  const shimX = cx + Math.sin(t*0.7)*radius*0.3;
  const shimY = cy + Math.cos(t*0.5)*radius*0.2;
  const shim = ctx.createRadialGradient(shimX,shimY,0,cx,cy,radius);
  shim.addColorStop(0,`hsla(${40+Math.sin(t)*20},70%,65%,0.12)`);
  shim.addColorStop(0.3,`hsla(${200+Math.cos(t*0.6)*40},60%,70%,0.06)`);
  shim.addColorStop(0.6,`hsla(${280+Math.sin(t*0.4)*30},50%,60%,0.04)`);
  shim.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = shim;
  ctx.fillRect(0,0,W,H);

  // Second shimmer sweep
  const shim2 = ctx.createLinearGradient(
    cx+Math.cos(t*0.3)*radius, cy+Math.sin(t*0.3)*radius,
    cx-Math.cos(t*0.3)*radius, cy-Math.sin(t*0.3)*radius
  );
  shim2.addColorStop(0,`hsla(${180+Math.sin(t*0.8)*40},60%,80%,0.05)`);
  shim2.addColorStop(0.5,`hsla(${45+Math.cos(t)*20},80%,70%,0.08)`);
  shim2.addColorStop(1,`hsla(${260+Math.sin(t*0.5)*30},50%,70%,0.04)`);
  ctx.fillStyle = shim2;
  ctx.fillRect(0,0,W,H);

  // Floating particles
  particles.forEach(p => {
    p.x += p.vx; p.y += p.vy; p.phase += p.speed;
    // Bounce in circle
    const dx = p.x-cx, dy = p.y-cy;
    if (dx*dx+dy*dy > (radius*0.9)*(radius*0.9)) {
      p.vx *= -1; p.vy *= -1;
    }
    const a = (Math.sin(p.phase)*0.4+0.6)*p.alpha;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    ctx.fillStyle = `hsla(${p.hue+Math.sin(p.phase*0.5)*20},60%,80%,${a})`;
    ctx.fill();
  });

  // Ripples
  ripples.forEach(r => { r.update(); r.draw(ctx); });
  ripples = ripples.filter(r => !r.done);

  // Vignette ring
  const vig = ctx.createRadialGradient(cx,cy,radius*0.55,cx,cy,radius);
  vig.addColorStop(0,'rgba(0,0,0,0)');
  vig.addColorStop(1,'rgba(0,0,0,0.75)');
  ctx.fillStyle = vig;
  ctx.fillRect(0,0,W,H);

  // Subtle reflection gleam top-left
  const gleam = ctx.createRadialGradient(cx*0.5,cy*0.4,0,cx*0.5,cy*0.4,radius*0.35);
  gleam.addColorStop(0,`rgba(255,245,230,${0.06+Math.sin(t*0.9)*0.02})`);
  gleam.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = gleam;
  ctx.fillRect(0,0,W,H);

  ctx.restore();

  // Outer rim
  ctx.beginPath();
  ctx.arc(cx,cy,radius-1,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(201,169,122,0.3)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  if (!entered) animFrame = requestAnimationFrame(drawMirror);
}

function addAmbientRipples() {
  if (entered) return;
  const angle = Math.random()*Math.PI*2;
  const r = Math.random()*radius*0.6;
  ripples.push(new Ripple(cx+Math.cos(angle)*r, cy+Math.sin(angle)*r));
  setTimeout(addAmbientRipples, 2200+Math.random()*2000);
}

// Touch/click mirror
function onMirrorInteract(e) {
  if (entered) return;
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  let x,y;
  if (e.touches) {
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else {
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  }
  // Check inside circle
  const dx = x-cx, dy = y-cy;
  if (dx*dx+dy*dy > radius*radius) return;

  // Entry ripple burst
  for (let i=0; i<3; i++) {
    setTimeout(() => ripples.push(new Ripple(x,y,i===0)), i*80);
  }
  if (navigator.vibrate) navigator.vibrate(30);

  // Haptic + sound + transition
  playEntry();
  entered = true;

  setTimeout(() => {
    cancelAnimationFrame(animFrame);
    crossThreshold();
  }, 900);
}

// Stars
function initStars() {
  const wrap = document.getElementById('stars');
  for (let i=0; i<60; i++) {
    const s = document.createElement('div');
    s.className='star';
    s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;
      --d:${2+Math.random()*4}s;--delay:${-Math.random()*4}s;
      opacity:${0.1+Math.random()*0.5};
      transform:scale(${1+Math.random()*1.5})`;
    wrap.appendChild(s);
  }
}

// ═══════════════════════════════════
// DATA
// ═══════════════════════════════════
const QUESTIONS_DAY = [
  "What are you pretending not to know right now?",
  "Who would you disappoint if you became more fully yourself?",
  "What feeling have you been calling by a safer name?",
  "What version of yourself are you most tired of maintaining?",
  "What conversation have you been rehearsing but never having?",
  "Where are you spending energy maintaining a story that exhausts you to keep telling?",
  "What part of your personality is actually a very old survival strategy?",
  "What would you feel if you stopped managing how others experience you?",
  "What were you doing the last time you forgot to check the time?",
  "What would you build if no one would ever know you built it?",
  "What do you know how to do that the world quietly needs?",
  "What is quietly asking to be born through you that you keep postponing?",
  "Who sees you most clearly - and do you let them?",
  "What are you most afraid of wanting?",
  "What would complete itself if you simply stopped interrupting it?",
  "What chapter are you still in that you know has already ended?",
  "What do you most want to receive that you find hardest to give?",
  "What are you tolerating that you've stopped noticing?",
  "What belief are you most afraid to examine?",
  "What would younger you be surprised by - and relieved by?",
  "What do you keep explaining about yourself that you wish needed no explanation?",
  "Where are you still auditioning for a role you already got?",
  "What would you stop doing tomorrow if approval were no longer available?",
  "What gift do you carry that you've been too afraid to fully offer?",
  "What are you more capable of than you've allowed yourself to demonstrate?",
  "Where do you see your own unlived life in someone else?",
  "What would you do today if you weren't afraid of being seen?",
  "Where in your life is silence asking to be allowed?",
  "What is already here that you keep looking past?",
  "What are you carrying that was never yours to carry?",
  "Where have you confused endurance with strength?",
  "What would you do differently if you loved yourself the way you love others?",
  "Are we really separate from one another - or is that the illusion?",
  "What truth are you keeping comfortable by keeping it vague?",
  "When do you feel most like yourself - and how often does that happen?",
  "What are you saving yourself for that keeps not arriving?",
  "Where are you living on an old map of yourself?",
  "What dimension of yourself have you never shown anyone?",
  "What would you explore if no one's opinion of you were at stake?",
  "What from your past are you still letting write your present?",
  "Who are you most envious of - and what does that point toward in yourself?",
  "What would you say to the people you love if you knew they could actually receive it?",
  "Who do you need to forgive - not for their sake but for the weight you're carrying?"
];

const QUESTIONS_NIGHT = [
  "What are you pretending not to know right now?",
  "What feeling have you been calling by a safer name?",
  "Who are you when nothing is required of you and no one is watching?",
  "Where in your body does the truth live before your mind gets to it?",
  "What have you been waiting for permission to want?",
  "What are you loyal to that is no longer loyal to you?",
  "If the version of you that you're becoming could speak - what would it not bother saying?",
  "What mask has been on so long you sometimes forget it isn't your face?",
  "What are you waiting to feel before you allow yourself to begin?",
  "What would you grieve if you finally let it be over?",
  "Where does your body brace before difficult things?",
  "What does your body know that your mind is still debating?",
  "Where do you hold the things you haven't said?",
  "What's the fear underneath the fear you already know about?",
  "Where are you choosing comfort over the thing that would actually free you?",
  "What's happening right now that you're not fully letting in?",
  "What simple thing would bring you back to yourself right now?",
  "Where are you living in a future that may never arrive?",
  "When did you last feel held by something larger than yourself?",
  "What are you when you subtract everything you've been told you are?",
  "What remains when you stop narrating your own experience?",
  "What were you before you learned to be careful?",
  "What arises when you sit in silence long enough for the performance to drop?",
  "What do you most avoid feeling - and how elaborate is the avoidance?",
  "What would you hear if you stopped filling the quiet?",
  "What conversation with yourself have you been avoiding?",
  "What if nothing is wrong?",
  "What if you are already enough - what then?",
  "What if the life you're waiting for is this one?",
  "What if the person you're becoming is already here?",
  "What if rest is not a reward but a practice?",
  "What if you are not behind?",
  "What if being truly seen is what you've been hungry for all along?",
  "Where do you perform closeness instead of feeling it?",
  "What are you anticipating so hard that you're missing what's already here?",
  "Where are you most dishonest with yourself - and what does that protect?",
  "Where does the sense of being a separate self feel most thin?",
  "What sensation do you override most frequently to keep functioning?",
  "What would change if you genuinely believed you were not separate?",
  "What is the quality of your relationship with your own company?",
  "Where do you go when you need to return to yourself?",
  "What would you feel if nothing needed to be different right now?",
  "What would it mean to stop waiting?"
];

const STATEMENTS = [
  "You have been kind to everyone except yourself.",
  "The waiting has become the life.",
  "You already know which relationship this is about.",
  "The version of you that you're performing is exhausted.",
  "What you're calling anxiety might be unexpressed aliveness.",
  "The door you keep circling has been open the whole time.",
  "You are not behind. There is no behind.",
  "The person you're most afraid of disappointing is you.",
  "What you're protecting yourself from is also what you need most.",
  "The grief you haven't named is still doing its work."
];

const ANCHORS = [
  "If nothing comes - that's the answer working.",
  "The wall is the door.",
  "You don't need to find the answer. Just stay with the question.",
  "The not-knowing is the most honest place to be.",
  "Let it stay open. That's enough.",
  "Your mind just met something it can't manage. Good.",
  "Sit here a while. Something is already shifting.",
  "The question doesn't need your answer. It needs your attention.",
  "If it feels unresolvable - you're in exactly the right place.",
  "Don't reach for the answer. Let the question reach into you.",
  "Stay. Something is arriving sideways.",
  "You already know. You just haven't let yourself know yet.",
  "The gap that opens is not empty."
];

const DEEPENERS = [
  "What would change if you answered honestly?",
  "What would it cost you to know?",
  "What are you protecting by not answering?",
  "Who taught you to keep this particular door closed?",
  "What does the body say when the mind goes quiet?"
];

const CLOSINGS = [
  "Something in you already knew\nwhat needed to be seen.\n\nYou just gave it room.",
  "You arrived here one way.\n\nSomething has shifted,\neven slightly.\n\nThat is not nothing.",
  "The clarity was always there.\n\nYou just interrupted\nwhat was covering it.",
  "You were honest\nfor a moment.\n\nThat's rarer than it seems.\n\nCarry it forward.",
  "The question stays with you now.\n\nLet it work\nwithout your help."
];

const EXIT_BLESSINGS = [
  "Go gently.",
  "Carry it lightly.",
  "Enough.",
  "Something has already shifted.",
  "The question walks with you now."
];

const WHISPER_FRAGMENTS = [
  "What are you\npretending\nnot to know?",
  "Who are you\nwhen no one\nis watching?",
  "The door\nhas always\nbeen open.",
  "What feeling\nhave you\nbeen avoiding?",
  "You are not\nbehind.",
  "What if\nnothing\nis wrong?",
  "The gap\nis not\nempty.",
  "What remains\nwhen you\nstop narrating?",
  "Are we really\nseparate?"
];

// ═══════════════════════════════════
// STATE
// ═══════════════════════════════════
let questionPool=[], poolIndex=0, questionCount=0, visitCount=0;
let isTeacherMode=false, currentScreen='', audioCtx=null;
let dissolveTimer=null,nextTimer=null,deepenerTimer=null,silenceTimer=null,lockedTimer=null;
let wordmarkHoldTimer=null;

// ═══════════════════════════════════
// AUDIO
// ═══════════════════════════════════
function playBowl() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if (audioCtx.state==='suspended') audioCtx.resume();
    const t=audioCtx.currentTime, freq=432;
    [[freq,0.18,4.5],[freq*2.756,0.06,2.8],[freq*5.4,0.025,1.5]].forEach(([f,g,dur],i)=>{
      const o=audioCtx.createOscillator(), gn=audioCtx.createGain();
      o.type='sine'; o.frequency.value=f;
      gn.gain.setValueAtTime(0,t);
      gn.gain.linearRampToValueAtTime(g,t+0.08);
      gn.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      const m=audioCtx.createGain(); m.gain.value=0.65;
      o.connect(gn); gn.connect(m); m.connect(audioCtx.destination);
      o.start(t); o.stop(t+dur+0.1);
    });
  } catch(e){}
}

function playEntry() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if (audioCtx.state==='suspended') audioCtx.resume();
    const t=audioCtx.currentTime;
    // Whoosh + low tone
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(220,t);
    o.frequency.exponentialRampToValueAtTime(110,t+1.2);
    g.gain.setValueAtTime(0,t);
    g.gain.linearRampToValueAtTime(0.15,t+0.15);
    g.gain.exponentialRampToValueAtTime(0.0001,t+2);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t+2.1);
  } catch(e){}
}

// ═══════════════════════════════════
// HELPERS
// ═══════════════════════════════════
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function isNight(){const h=new Date().getHours();return h>=21||h<6}
function pickQuestion(){
  if(poolIndex>=questionPool.length){questionPool=shuffle(isNight()?QUESTIONS_NIGHT:QUESTIONS_DAY);poolIndex=0}
  return questionPool[poolIndex++];
}
function pickAnchor(){return ANCHORS[Math.floor(Math.random()*ANCHORS.length)]}
function pickDeepener(){return DEEPENERS[Math.floor(Math.random()*DEEPENERS.length)]}

function showIScreen(id){
  document.querySelectorAll('.iscreen').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='flex';
  currentScreen=id.replace('iscreen-','');
  if(id==='iscreen-breath') startBreathPacer(2);
  else stopBreathPacer();
}

function clearTimers(){
  [dissolveTimer,nextTimer,deepenerTimer,silenceTimer,lockedTimer].forEach(t=>clearTimeout(t));
  dissolveTimer=nextTimer=deepenerTimer=silenceTimer=lockedTimer=null;
}

function animateWords(el,text,baseDelay=0,perWord=110){
  el.innerHTML='';
  text.split(' ').forEach((w,i)=>{
    const s=document.createElement('span');
    s.className='word';
    s.textContent=(i<text.split(' ').length-1)?w+' ':w;
    s.style.animationDelay=(baseDelay+i*perWord)+'ms';
    el.appendChild(s);
  });
}

// ═══════════════════════════════════
// CROSS THRESHOLD
// ═══════════════════════════════════
function crossThreshold() {
  const welcome = document.getElementById('screen-welcome');
  const interior = document.getElementById('interior');

  welcome.classList.add('exiting');
  interior.style.display='block';
  setTimeout(()=>interior.classList.add('visible'), 50);

  // Show wordmark
  setTimeout(()=>{
    document.getElementById('wordmark').classList.add('visible');
  }, 800);

  // Whispers
  const frags=shuffle([...WHISPER_FRAGMENTS]);
  ['w1','w2','w3','w4'].forEach((id,i)=>{
    document.getElementById(id).textContent=frags[i]||'';
  });

  // Breath sequence
  showIScreen('iscreen-breath');
  questionPool=shuffle(isNight()?QUESTIONS_NIGHT:QUESTIONS_DAY);
  poolIndex=0; questionCount=0;

  // Allow tap on the ring to advance immediately
  const ring=document.querySelector('#iscreen-breath .breath-ring');
  if(ring && !ring.dataset.bound){
    ring.dataset.bound='1';
    ring.addEventListener('click', ()=>{ stopBreathPacer(); displayQuestion(); }, {passive:true});
    ring.addEventListener('touchstart', ()=>{ /* iOS: hint of intent only */ }, {passive:true});
  }

// Show whispers after a moment
  setTimeout(()=>{
    document.querySelectorAll('.whisper').forEach(w=>w.classList.add('visible'));
  },8000);
}

// ═══════════════════════════════════
// QUESTION DISPLAY
// ═══════════════════════════════════
function displayQuestion() {
  clearTimers();
  const nb=document.getElementById('next-btn');
  nb.classList.remove('visible'); nb.style.display='none';

  // Statement 1 in 14
  if (Math.random()<0.072 && questionCount>0){displayStatement();return;}

  questionCount++;
  const isLocked7=(questionCount%7===0)&&!isTeacherMode;
  const q=pickQuestion();

  showIScreen('iscreen-question');
  const qEl=document.getElementById('q-text');
  const aEl=document.getElementById('anchor-text');
  const dEl=document.getElementById('deepener-text');
  const lEl=document.getElementById('locked-notice');

  aEl.style.opacity='0'; aEl.classList.remove('visible');
  dEl.style.opacity='0'; dEl.classList.remove('visible');
  lEl.classList.remove('visible'); qEl.innerHTML='';

  setTimeout(()=>playBowl(),200);
  if(navigator.vibrate)navigator.vibrate(20);

  animateWords(qEl,q,100,110);
  aEl.textContent=pickAnchor();

  const wc=q.split(' ').length;
  setTimeout(()=>aEl.classList.add('visible'), 100+wc*110+1200);
  deepenerTimer=setTimeout(()=>dEl.classList.add('visible'),40000);
  dEl.textContent=pickDeepener();

  if(isLocked7){
    lEl.classList.add('visible');
    lockedTimer=setTimeout(()=>{nb.style.display='flex';setTimeout(()=>nb.classList.add('visible'),40);},90000);
  } else {
    nextTimer=setTimeout(()=>{nb.style.display='flex';setTimeout(()=>nb.classList.add('visible'),40);},7000);
  }

  silenceTimer=setTimeout(()=>{if(currentScreen==='question')showClosing();},180000);
  dissolveTimer=setTimeout(()=>{qEl.style.transition='opacity 1.5s ease';qEl.style.opacity='0.12';},90000);
  qEl.addEventListener('click',function r(){qEl.style.opacity='1';clearTimeout(dissolveTimer);qEl.removeEventListener('click',r);},{once:true});
}

function displayStatement(){
  clearTimers();
  const nb=document.getElementById('next-btn');
  nb.classList.remove('visible');nb.style.display='none';
  const s=STATEMENTS[Math.floor(Math.random()*STATEMENTS.length)];
  showIScreen('iscreen-statement');
  const sEl=document.getElementById('s-text');
  sEl.innerHTML='';
  setTimeout(()=>playBowl(),300);
  if(navigator.vibrate)navigator.vibrate(20);
  animateWords(sEl,s,200,160);
  nextTimer=setTimeout(()=>{nb.style.display='flex';setTimeout(()=>nb.classList.add('visible'),40);},12000);
  silenceTimer=setTimeout(()=>showClosing(),180000);
}

function nextQuestion(){
  if(questionCount>=3&&Math.random()>0.62){showClosing();return;}
  displayQuestion();
}

function showClosing(){
  clearTimers();
  const nb=document.getElementById('next-btn');
  nb.classList.remove('visible');nb.style.display='none';
  document.querySelectorAll('.whisper').forEach(w=>w.classList.remove('visible'));
  showIScreen('iscreen-close');
  const cEl=document.getElementById('closing-text');
  const rBtn=document.getElementById('return-btn');
  cEl.textContent=CLOSINGS[Math.floor(Math.random()*CLOSINGS.length)];
  cEl.style.cssText='opacity:0;animation:none;'; rBtn.style.cssText='opacity:0;';
  cEl.offsetHeight;
  cEl.style.animation='qup 2s cubic-bezier(0.16,1,0.3,1) forwards 0.4s';
  setTimeout(()=>{rBtn.style.animation='softin 1.5s ease forwards';},2800);
}

function returnToPortal(){
  // Exit blessing
  const eb=document.getElementById('exit-blessing');
  const et=document.getElementById('exit-text');
  et.textContent=EXIT_BLESSINGS[Math.floor(Math.random()*EXIT_BLESSINGS.length)];
  eb.classList.add('visible');
  setTimeout(()=>{
    eb.style.opacity='0';
    setTimeout(()=>{eb.classList.remove('visible');eb.style.opacity='';},1000);
  },2200);

  // Reset to mirror
  const interior=document.getElementById('interior');
  const welcome=document.getElementById('screen-welcome');
  interior.classList.remove('visible');
  setTimeout(()=>{
    interior.style.display='none';
    welcome.classList.remove('exiting');
    entered=false;
    document.getElementById('wordmark').classList.remove('visible');
    document.querySelectorAll('.whisper').forEach(w=>w.classList.remove('visible'));
    // Restart mirror animation
    resizeMirror();
    initParticles();
    animFrame=requestAnimationFrame(drawMirror);
    addAmbientRipples();
  },1200);
}

// Teacher mode
function initWordmarkHold(){
  const wm=document.getElementById('wordmark');
  wm.addEventListener('mousedown',()=>{wordmarkHoldTimer=setTimeout(toggleTeacher,3000)});
  wm.addEventListener('touchstart',()=>{wordmarkHoldTimer=setTimeout(toggleTeacher,3000)},{passive:true});
  ['mouseup','mouseleave','touchend'].forEach(e=>wm.addEventListener(e,()=>clearTimeout(wordmarkHoldTimer)));
}
\1

// Ambient mode (minimal UI). Toggle with "A" key, or long-press Teacher badge (teacher-mode only).
let isAmbientMode = false;
function toggleAmbient(force){
  isAmbientMode = (typeof force === 'boolean') ? force : !isAmbientMode;
  document.body.classList.toggle('ambient-mode', isAmbientMode);
  try{
    const msg = isAmbientMode ? "Ambient mode on" : "Ambient mode off";
    // Subtle haptic acknowledgement
    if(navigator.vibrate) navigator.vibrate(isAmbientMode ? [20,40,20] : [15]);
    // Optional: update breath subtext without changing layout
    const sub = document.getElementById('breath-sub');
    if(sub) sub.setAttribute('data-ambient', isAmbientMode ? '1' : '0');
  }catch(e){}
}

// Long-press helper (re-used)
function onLongPress(el, ms, fn){
  let t=null;
  const start=()=>{ t=setTimeout(fn, ms); };
  const end=()=>{ if(t) { clearTimeout(t); t=null; } };
  ['mousedown','touchstart'].forEach(ev=>el.addEventListener(ev,start,{passive:true}));
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>el.addEventListener(ev,end,{passive:true}));
}

// Attach long-press to Teacher badge once it exists
function initAmbientToggle(){
  const badge = document.getElementById('teacher-badge');
  if(!badge) return;
  onLongPress(badge, 650, ()=>{ if(isTeacherMode) toggleAmbient(); });
}

// Prefer-reduced-motion: simplify heavy visuals
const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

// Visit counter
function initVisitCount(){
  try{
    visitCount=parseInt(localStorage.getItem('portal_visits')||'0')+1;
    localStorage.setItem('portal_visits',visitCount);
  }catch(e){visitCount=1}
  if(visitCount>1){
    const vc=document.getElementById('visit-count');
    vc.textContent=visitCount;
    setTimeout(()=>vc.classList.add('visible'),3000);
  }
}

// ═══════════════════════════════════
// INPUT
// ═══════════════════════════════════
document.addEventListener('keydown',e=>{
  if(e.key==='a' || e.key==='A'){
    if(entered){ e.preventDefault(); toggleAmbient(); }
    return;
  }
  if(e.key===' '||e.key==='Enter'){
    e.preventDefault();
    const nb=document.getElementById('next-btn');
    if(!entered){
      // Trigger mirror touch from centre
      entered=true;
      ripples.push(new Ripple(cx,cy,true));
      playEntry();
      setTimeout(()=>{cancelAnimationFrame(animFrame);crossThreshold();},900);
    } else if((currentScreen==='question'||currentScreen==='statement')&&nb.classList.contains('visible')){
      nextQuestion();
    } else if(currentScreen==='close'){
      returnToPortal();
    }
  }
});

let ty=0;
document.addEventListener('touchstart',e=>{ty=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend',e=>{
  const diff=ty-e.changedTouches[0].clientY;
  if(diff>55&&entered){
    const nb=document.getElementById('next-btn');
    if((currentScreen==='question'||currentScreen==='statement')&&nb.classList.contains('visible'))nextQuestion();
  }
},{passive:true});

// ═══════════════════════════════════
// INIT
// ═══════════════════════════════════
window.addEventListener('resize',()=>{if(!entered){resizeMirror();initParticles();}});

function init(){
  // Breath control chips
  const paceBtn=document.getElementById('pace-btn');
  if(paceBtn && !paceBtn.dataset.bound){
    paceBtn.dataset.bound='1';
    paceBtn.addEventListener('click', ()=>{
      paceIndex=(paceIndex+1)%PACE_PRESETS.length;
      setPace(PACE_PRESETS[paceIndex]);
      // restart pacer if currently on breath screen
      if(currentScreen==='breath') startBreathPacer(2);
    });
  }
  const hBtn=document.getElementById('haptic-btn');
  if(hBtn && !hBtn.dataset.bound){
    hBtn.dataset.bound='1';
    hBtn.addEventListener('click', ()=>setHaptics(!hapticsOn));
  }

  // Default pace + haptics off
  setPace(PACE_PRESETS[paceIndex]);
  setHaptics(false);


  initStars();
  resizeMirror();
  initParticles();
  animFrame=requestAnimationFrame(drawMirror);
  addAmbientRipples();
  initWordmarkHold();
  initVisitCount();

  // Mirror touch events
  const wrap=document.getElementById('mirror-wrap');
  canvas.addEventListener('click',onMirrorInteract);
  canvas.addEventListener('touchstart',onMirrorInteract,{passive:false});

  // Also allow tapping the label
  document.querySelector('.mirror-label').addEventListener('click',onMirrorInteract);
  document.querySelector('.mirror-label').addEventListener('touchstart',onMirrorInteract,{passive:false});
}

init();
document.addEventListener('DOMContentLoaded',()=>{ initAmbientToggle(); });
</script>
</body>
</html>